# Paragraph Override Feature

**Date**: October 7, 2025  
**Status**: Updated - Outputs moved to Control Panel  
**Last Updated**: October 7, 2025

## Overview

The `MediaDescribe` node includes paragraph override functionality and displays individual paragraph outputs in a dedicated control panel. This feature allows you to:

1. **Override specific paragraphs** generated by Gemini with your own custom text (via Media Describe - Overrides node)
2. **View individual paragraphs** in an organized control panel widget
3. **Access paragraph data** via the `all_media_describe_data` JSON output
4. **Mix and match** Gemini-generated content with your custom content

## Override Fields (via Media Describe - Overrides Node)

All override fields are optional text inputs in the separate **Media Describe - Overrides** node. When populated, they replace Gemini's output for that specific paragraph:

| Field Name                     | Type               | Description                                             | Applies To      |
| ------------------------------ | ------------------ | ------------------------------------------------------- | --------------- |
| `override_subject`             | STRING (multiline) | Override text for SUBJECT paragraph                     | Images & Videos |
| `override_cinematic_aesthetic` | STRING (multiline) | Override text for CINEMATIC AESTHETIC CONTROL paragraph | Images & Videos |
| `override_stylization_tone`    | STRING (multiline) | Override text for STYLIZATION & TONE paragraph          | Images & Videos |
| `override_clothing`            | STRING (multiline) | Override text for CLOTHING paragraph                    | Images & Videos |
| `override_scene`               | STRING (multiline) | Override text for SCENE paragraph                       | Videos Only     |
| `override_movement`            | STRING (multiline) | Override text for MOVEMENT paragraph                    | Videos Only     |

## Output Fields

The MediaDescribe node returns:

| Output Name               | Index | Type   | Description                                    |
| ------------------------- | ----- | ------ | ---------------------------------------------- |
| `description`             | 0     | STRING | Full combined description (with overrides)     |
| `media_info`              | 1     | STRING | Media information                              |
| `gemini_status`           | 2     | STRING | Gemini API status                              |
| `processed_media_path`    | 3     | STRING | Path to processed media                        |
| `final_string`            | 4     | STRING | Description with prefix applied                |
| `height`                  | 5     | INT    | Media height                                   |
| `width`                   | 6     | INT    | Media width                                    |
| `all_media_describe_data` | 7     | STRING | Aggregated JSON data (includes all paragraphs) |

## Control Panel Widget

Individual paragraphs are displayed in the **📋 Paragraph Outputs** control panel widget on the MediaDescribe node:

- 🎯 **Subject** - Subject/main focus paragraph (with override applied)
- 🎬 **Cinematic** - Cinematic aesthetic control paragraph (with override applied)
- 🎨 **Style/Tone** - Stylization & tone paragraph (with override applied)
- 👔 **Clothing** - Clothing details paragraph (with override applied)
- 🏞️ **Scene** - Scene description (video only, with override applied)
- 🎭 **Movement** - Movement/action description (video only, with override applied)

> **Note**: The control panel provides a clean, organized view of all paragraph outputs without cluttering the node with multiple output sockets.

## How It Works

### 1. Paragraph Parsing

When Gemini generates a description, it's split into individual paragraphs based on blank lines (`\n\n`). The paragraphs are mapped to their respective categories in order:

**For Images (Text2Image mode):**

1. Subject (if enabled)
2. Cinematic Aesthetic Control
3. Stylization & Tone
4. Clothing (if enabled)

**For Videos:**

1. Subject (if enabled)
2. Clothing (if enabled)
3. Scene
4. Movement
5. Cinematic Aesthetic Control
6. Stylization & Tone

### 2. Override Application

After parsing, any non-empty override fields replace the corresponding parsed paragraphs:

```python
# Example: Override only the subject
if override_subject.strip():
    subject = override_subject.strip()
```

### 3. Final Description Reconstruction

The final description is reconstructed from all non-empty paragraphs, maintaining the proper order and paragraph separation.

## Use Cases

### Use Case 1: Consistent Subject Descriptions

Keep the subject description consistent across multiple images while letting Gemini describe the scene:

```
override_subject = "A woman with wavy shoulder-length hair, standing confidently with hands on hips."
```

All other paragraphs (cinematic aesthetic, stylization & tone, clothing) will be generated by Gemini.

### Use Case 2: Custom Cinematic Style

Force a specific cinematic style while letting Gemini analyze the image content:

```
override_cinematic_aesthetic = "Warm golden hour lighting from camera left, medium close-up shot at eye level, shallow depth of field with f/2.8, natural exposure."
override_stylization_tone = "Cinematic realism with a dreamy, nostalgic mood."
```

### Use Case 3: Clothing Control for Brand Consistency

Specify exact clothing descriptions for brand consistency:

```
override_clothing = "A fitted navy blue blazer with peak lapels, crisp white dress shirt, slim-fit charcoal trousers, and polished black oxford shoes."
```

### Use Case 4: Video Movement Override

For videos, override the movement paragraph to describe specific choreography:

```
override_movement = "The subject begins with a subtle hip sway on the downbeat, then transitions into a full body wave, lifting the right arm upward while the torso tilts left. Weight shifts from left to right foot as the camera slowly pans to follow."
```

### Use Case 5: Selective Override Workflow

Use individual paragraph outputs to create a workflow where you:

1. Run MediaDescribe once to get Gemini's suggestions
2. Review each paragraph output
3. Modify only the paragraphs you want to change
4. Feed the overrides back into MediaDescribe (or use directly in your workflow)

## Examples

### Example 1: Complete Override (Custom Text, No Gemini)

**Setup:**

- Fill all override fields with your custom text
- Gemini still runs (for caching/consistency), but its output is completely replaced

**Result:**

- `description` = Your custom paragraphs combined
- Individual outputs (`subject`, `cinematic_aesthetic`, etc.) = Your override text

### Example 2: Partial Override (Mix Gemini + Custom)

**Setup:**

```
override_subject = "A man with short cropped hair, sitting casually with crossed legs."
# Leave other overrides empty
```

**Result:**

- `subject` = Your custom subject text
- `cinematic_aesthetic` = Gemini-generated
- `stylization_tone` = Gemini-generated
- `clothing` = Gemini-generated (if enabled)
- `description` = All paragraphs combined (custom subject + Gemini for rest)

### Example 3: Using Individual Outputs

**Workflow:**

```
[MediaDescribe] → (subject) → [String Input Widget]
               → (cinematic_aesthetic) → [String Input Widget]
               → (clothing) → [String Input Widget]

[User reviews and edits in UI]

[Edited outputs] → [Combine Strings] → [Final Prompt]
```

## Implementation Details

### Paragraph Parsing Logic

```python
def _parse_paragraphs(self, description, override_subject="",
                      override_cinematic_aesthetic="",
                      override_stylization_tone="",
                      override_clothing="", override_scene="",
                      override_movement=""):
    # Split by blank lines
    paragraphs = [p.strip() for p in description.split('\n\n') if p.strip()]

    # Map to variables
    subject = paragraphs[0] if len(paragraphs) > 0 else ""
    cinematic_aesthetic = paragraphs[1] if len(paragraphs) > 1 else ""
    # ... etc

    # Apply overrides
    if override_subject.strip():
        subject = override_subject.strip()
    # ... etc

    # Rebuild final description
    final_parts = [p for p in [subject, cinematic_aesthetic, ...] if p]
    final_description = "\n\n".join(final_parts)

    return (subject, cinematic_aesthetic, ..., final_description)
```

### Return Value Changes

**Before:**

```python
return (description, media_info, gemini_status, processed_media_path,
        final_string, height, width, all_media_describe_data)
```

**After:**

```python
return (description, media_info, gemini_status, processed_media_path,
        final_string, height, width, all_media_describe_data,
        subject, cinematic_aesthetic, stylization_tone, clothing,
        scene, movement)
```

## Updated `all_media_describe_data` Format

The aggregated JSON output now includes individual paragraphs:

```json
{
    "description": "Full combined description",
    "media_info": "Media information...",
    "gemini_status": "Gemini status...",
    "processed_media_path": "/path/to/media",
    "final_string": "Prefix + description",
    "height": 1080,
    "width": 1920,
    "subject": "Subject paragraph text",
    "cinematic_aesthetic": "Cinematic aesthetic paragraph text",
    "stylization_tone": "Stylization & tone paragraph text",
    "clothing": "Clothing paragraph text",
    "scene": "Scene paragraph text (video)",
    "movement": "Movement paragraph text (video)"
}
```

## Backward Compatibility

✅ **Fully Backward Compatible**

- All override fields are optional with default empty strings
- Existing workflows continue to work without changes
- If no overrides are provided, behavior is identical to previous version
- New outputs are additive (existing output indices unchanged)

## Benefits

### 1. Fine-Grained Control

Control individual aspects of the description without needing to regenerate everything.

### 2. Consistency Across Batches

Keep certain elements consistent (e.g., subject description) while varying others.

### 3. Hybrid Workflows

Combine AI-generated content with human-curated content for optimal results.

### 4. Debugging & Iteration

Review individual paragraphs to understand what Gemini generated and iterate on specific sections.

### 5. Template-Based Generation

Create templates with pre-filled paragraphs and only let Gemini fill in specific sections.

## Notes

- **Order Matters**: Paragraphs are parsed in the order Gemini generates them (based on the system prompt structure)
- **Empty Paragraphs**: If Gemini doesn't generate a paragraph (e.g., clothing disabled), that output will be empty unless overridden
- **Video vs Image**: Video has 6 paragraphs total; images typically have 3-4 depending on settings
- **Caching**: Overrides are applied AFTER cache lookup, so overriding doesn't affect cache hits
- **Final Description**: The `description` output always reflects the final combined text with all overrides applied

---

**Feature Status**: ✅ Complete and Production Ready  
**Breaking Changes**: None  
**Migration Required**: None
